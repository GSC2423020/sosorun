# =========================================
# 이 파일은 Docker Compose 설정 파일입니다.
# 여러 개의 컨테이너(DB, PHP, Nginx)를
# 한 번에 실행하기 위한 "설계도"입니다.
# =========================================

services:   # 실행할 컨테이너 목록 시작

  # ==================================================
  # 1️⃣ PostgreSQL (데이터베이스)
  # ==================================================
  postgres:
    image: postgres:16   # PostgreSQL 16 공식 이미지 사용

    container_name: sosorun_postgres  # 컨테이너 이름 지정

    # DB 생성에 필요한 환경 변수 (.env에서 가져옴)
    environment:
      POSTGRES_DB: ${POSTGRES_DB}              # 생성할 데이터베이스 이름
      POSTGRES_USER: ${POSTGRES_USER}          # DB 사용자 이름
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}  # DB 비밀번호

    # 외부(내 PC)에서 DB 접속 가능하게 포트 연결
    ports:
      - "${POSTGRES_PORT}:5432"   # PC포트 → 컨테이너 5432

    # 데이터 영구 저장 설정
    volumes:
      # DB 데이터를 도커 볼륨에 저장 (컨테이너 삭제해도 유지)
      - postgres_data:/var/lib/postgresql/data

      # 컨테이너 "최초 생성 시" 자동 실행될 SQL 파일
      - ./infra/postgres/init.sql:/docker-entrypoint-initdb.d/init.sql

    # DB가 정상 실행됐는지 검사하는 설정
    healthcheck:
      # pg_isready 명령어로 DB 준비 상태 확인
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]

      interval: 5s   # 5초마다 검사
      timeout: 5s    # 5초 이상 응답 없으면 실패
      retries: 10    # 10번 실패하면 unhealthy 처리



  # ==================================================
  # 2️⃣ PHP (백엔드 서버)
  # ==================================================
  php:
    build:
      context: ./infra/php      # Dockerfile 위치
      dockerfile: Dockerfile    # 사용할 Dockerfile

    container_name: sosorun_php

    # 로컬 프로젝트 파일을 컨테이너에 연결
    volumes:
      - ./:/var/www/html

    # 컨테이너 내부 작업 디렉토리
    working_dir: /var/www/html

    # postgres가 "정상 상태(healthy)"일 때만 실행
    depends_on:
      postgres:
        condition: service_healthy



  # ==================================================
  # 3️⃣ Nginx (웹 서버)
  # ==================================================
  nginx:
    image: nginx:1.27-alpine   # 가벼운 Nginx 이미지

    container_name: sosorun_nginx

    # 외부 접속 포트 설정
    ports:
      - "${NGINX_PORT}:80"     # PC 포트 → 컨테이너 80

    volumes:
      # 프로젝트 파일 연결 (정적 파일 제공용)
      - ./:/var/www/html

      # nginx 설정 파일 연결
      - ./infra/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro

    # php가 먼저 실행되어야 함
    depends_on:
      - php



# ==================================================
# 도커 볼륨 정의 (데이터 저장소)
# ==================================================
volumes:
  postgres_data:   # DB 데이터 영구 저장용 볼륨
