services:

  # =====================================================
  # 1️⃣ PostgreSQL (데이터베이스)
  # =====================================================
  # 가장 아래 레이어 (모든 서비스가 의존)
  postgres:
    image: postgres:16                     # PostgreSQL 16 공식 이미지
    container_name: sosorun-postgres       # 컨테이너 이름
    restart: unless-stopped                # 중단되지 않는 한 자동 재시작

    # DB 생성에 필요한 환경 변수 (.env에서 읽음)
    environment:
      POSTGRES_DB: ${POSTGRES_DB}          # 생성할 DB 이름
      POSTGRES_USER: ${POSTGRES_USER}      # DB 사용자
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD} # DB 비밀번호
      TZ: ${TZ}                            # 시간대 설정

    ports:
      - "5432:5432"                        # PC 5432 → 컨테이너 5432

    volumes:
      # DB 데이터를 영구 보관 (컨테이너 삭제해도 데이터 유지)
      - pg_data:/var/lib/postgresql/data

      # 컨테이너 최초 실행 시 자동 실행되는 초기 SQL
      - ./infra/postgres/init.sql:/docker-entrypoint-initdb.d/init.sql:ro



  # =====================================================
  # 2️⃣ API (NestJS 서버)
  # =====================================================
  # DB 위에서 동작하는 백엔드 서버
  api:
    image: node:22-alpine                  # Node 22 경량 이미지
    container_name: sosorun-api
    working_dir: /app                      # 컨테이너 내부 작업 디렉토리
    restart: unless-stopped

    # postgres가 먼저 실행되어야 함
    depends_on:
      - postgres

    # API 서버에 전달할 환경 변수
    environment:
      # 서비스 이름 postgres를 사용해 내부 네트워크 연결
      # Docker 내부 DNS가 "postgres"를 DB 컨테이너로 자동 연결
      DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}?schema=public
      PORT: 3001

    volumes:
      - ./:/app                            # 로컬 코드 → 컨테이너에 연결

    # 컨테이너 실행 시 수행할 명령어
    # 1. corepack 활성화 (pnpm 사용 준비)
    # 2. pnpm 설치
    # 3. api만 실행
    command: sh -lc "corepack enable && pnpm -v && pnpm install && pnpm --filter @sosorun/api start:dev"

    ports:
      - "3001:3001"                        # PC 3001 → API 컨테이너 3001



  # =====================================================
  # 3️⃣ Web (Next.js 프론트엔드)
  # =====================================================
  # API 위에서 동작하는 프론트엔드
  web:
    image: node:22-alpine
    container_name: sosorun-web
    working_dir: /app
    restart: unless-stopped

    # API가 먼저 떠 있어야 정상 통신 가능
    depends_on:
      - api

    volumes:
      - ./:/app

    # Next.js 개발 서버 실행
    command: sh -lc "corepack enable && pnpm -v && pnpm install && pnpm --filter @sosorun/web dev"

    ports:
      - "3000:3000"                        # PC 3000 → Web 컨테이너 3000



  # =====================================================
  # 4️⃣ Nginx (Reverse Proxy)
  # =====================================================
  # 가장 앞단에서 모든 요청을 받아서
  # web 또는 api로 분기해주는 프록시 서버
  nginx:
    image: nginx:1.27-alpine
    container_name: sosorun-nginx
    restart: unless-stopped

    # web, api가 먼저 실행되어야 함
    depends_on:
      - web
      - api

    ports:
      - "8080:80"                          # PC 8080 → nginx 80

    volumes:
      - ./infra/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro



# =====================================================
# 볼륨 정의 (데이터 영구 저장)
# =====================================================
volumes:
  pg_data:
