# =========================================================
# 이 파일은 Nginx 설정 파일입니다.
# 브라우저 요청을 받아서
# 1) 정적 파일(이미지/JS/CSS)은 Nginx가 직접 제공하고
# 2) PHP 요청은 PHP-FPM 컨테이너(php:9000)로 전달합니다.
#
# Laravel은 반드시 "public" 폴더를 웹 루트로 사용해야 안전합니다.
# (public 밖에는 .env 같은 민감한 파일이 있을 수 있음)
# =========================================================

server {
    listen 80;                 # Nginx가 컨테이너 내부 80번 포트에서 요청을 받음
    server_name localhost;     # localhost로 들어오는 요청을 이 서버 설정이 처리

    # Laravel의 public 폴더를 웹 루트로 설정
    # → 브라우저가 접근 가능한 파일은 public 안에만 두는 게 정석(보안)
    root /var/www/html/public;

    # 기본으로 열어줄 파일 이름 목록
    # / 로 접근하면 index.php(또는 index.html)를 찾음
    index index.php index.html;

    # -----------------------------
    # 1) 라우팅 처리 (Laravel로 넘기기)
    # -----------------------------
    location / {
        # try_files 동작 순서:
        # 1) 요청한 경로에 "파일"이 있으면 그 파일을 그대로 반환
        # 2) 요청한 경로에 "폴더"가 있으면 그 폴더로 접근(내부 index 처리)
        # 3) 둘 다 없으면 Laravel의 /index.php로 넘겨서 라우팅 처리
        #    (예: /posts/1 같은 URL은 실제 파일이 없으니 Laravel이 처리)
        try_files $uri $uri/ /index.php?$query_string;
    }

    # -----------------------------
    # 2) PHP 파일 처리 (PHP-FPM으로 전달)
    # -----------------------------
    location ~ \.php$ {
        # PHP 실행에 필요한 기본 FastCGI 설정 불러오기
        include fastcgi_params;

        # "php"라는 서비스(컨테이너)의 9000 포트(PHP-FPM)로 전달
        # docker-compose에서 service 이름이 php라서 php:9000으로 접근 가능
        fastcgi_pass php:9000;

        # 기본 실행 파일 이름을 index.php로 설정
        fastcgi_index index.php;

        # 실제로 실행할 PHP 파일의 전체 경로를 PHP-FPM에게 알려줌
        # 예: /var/www/html/public + /index.php
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    }

    # -----------------------------
    # 3) 보안 설정: 숨김 파일 접근 차단
    # -----------------------------
    location ~ /\.(?!well-known).* {
        # .env, .git 같은 숨김 파일은 외부에서 접근하면 위험
        # 그래서 모두 차단하는 것이 실무 정석
        deny all;
    }
}
