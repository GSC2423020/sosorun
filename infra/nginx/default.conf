# =========================================
# SOSORUN local reverse proxy
# - http://localhost:8080 ìœ¼ë¡œ ì ‘ì†í•˜ë©´
#   /     -> Next.js (3000)
#   /api  -> NestJS  (3001)
# =========================================

server {
  listen 80;                 # ì»¨í…Œì´ë„ˆ ë‚´ë¶€ 80ë²ˆ í¬íŠ¸ì—ì„œ ëŒ€ê¸°
  server_name localhost;     # localhost ìš”ì²­ ì²˜ë¦¬

  # -----------------------------
  # 1) API í”„ë¡ì‹œ: /api -> NestJS
  # -----------------------------
  location /api/ {

    # ğŸ”¥ í•µì‹¬ ë³€ê²½ ë¶€ë¶„
    # host.docker.internal ëŒ€ì‹  "api" ì‚¬ìš©
    #
    # ì´ìœ :
    # - Docker Composeë¥¼ ì“°ë©´ ê°™ì€ ë„¤íŠ¸ì›Œí¬ ì•ˆì˜ ì»¨í…Œì´ë„ˆëŠ”
    #   "ì„œë¹„ìŠ¤ ì´ë¦„"ìœ¼ë¡œ ì„œë¡œ í†µì‹  ê°€ëŠ¥
    # - host.docker.internalì€ OS/í™˜ê²½ì— ë”°ë¼ ë™ì‘ì´ ë‹¤ë¦„ (Linuxì—ì„œëŠ” ì•ˆ ë  ìˆ˜ ìˆìŒ)
    # - ì„œë¹„ìŠ¤ ì´ë¦„ì„ ì“°ëŠ” ê²ƒì´ Docker ê³µì‹/ì‹¤ë¬´ ì •ì„ ë°©ì‹
    #
    # ì¦‰:
    #   nginx ì»¨í…Œì´ë„ˆ â†’ api ì»¨í…Œì´ë„ˆ 3001ë²ˆìœ¼ë¡œ ì§ì ‘ í†µì‹ 
    #
    proxy_pass http://api:3001/;

    proxy_http_version 1.1;

    # ===== ì‹¤ë¬´ í”„ë¡ì‹œ ê¸°ë³¸ í—¤ë” ì„¸íŠ¸ =====
    proxy_set_header Host $host;                       # ì›ë˜ ìš”ì²­í•œ í˜¸ìŠ¤íŠ¸ ì •ë³´ ì „ë‹¬
    proxy_set_header X-Real-IP $remote_addr;           # ì‹¤ì œ í´ë¼ì´ì–¸íŠ¸ IP ì „ë‹¬
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; # í”„ë¡ì‹œ ì²´ì¸ IP ìœ ì§€
    proxy_set_header X-Forwarded-Proto $scheme;        # http / https ì •ë³´ ì „ë‹¬
  }


  # -----------------------------
  # 2) Web í”„ë¡ì‹œ: / -> Next.js
  # -----------------------------
  location / {

    # ğŸ”¥ ë™ì¼í•˜ê²Œ ì„œë¹„ìŠ¤ ì´ë¦„ "web" ì‚¬ìš©
    #
    # nginx â†’ web ì»¨í…Œì´ë„ˆ 3000ë²ˆ ì§ì ‘ ì—°ê²°
    # Docker ë‚´ë¶€ ë„¤íŠ¸ì›Œí¬ì—ì„œ ì„œë¹„ìŠ¤ ì´ë¦„ì´ ê³§ DNS ì—­í• ì„ í•¨
    #
    proxy_pass http://web:3000;

    proxy_http_version 1.1;

    # Next.js ê°œë°œ ì„œë²„ëŠ” HMR(í•« ë¦¬ë¡œë“œ)ì—ì„œ WebSocket ì‚¬ìš©
    # ì•„ë˜ ì„¤ì •ì´ ì—†ìœ¼ë©´ ì‹¤ì‹œê°„ ìƒˆë¡œê³ ì¹¨ì´ ê¹¨ì§ˆ ìˆ˜ ìˆìŒ
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";

    proxy_set_header Host $host;
  }
}
